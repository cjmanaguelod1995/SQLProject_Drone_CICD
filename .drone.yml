kind: pipeline
type: docker
name: PR

steps:    
  - name: clean
    image: mcr.microsoft.com/dotnet/sdk:latest
    commands:
     - dotnet clean SQLProject_Drone_CICD.sln
     
  - name: build
    image: mcr.microsoft.com/dotnet/core/sdk:latest
    commands:
     - dotnet build SQLProject_Drone_CICD.sln
  
  - name: publish
    image: mcr.microsoft.com/dotnet/core/sdk:3.1
    commands:
        - apt-get update -y
        - apt-get upgrade -y
        - apt-get install zip unzip -y
        - dotnet publish --configuration SQLProject_Drone_CICD.sln --output /drone/src/netstandard2.0\publish\
        - cd /drone/src/netstandard2.0\publish\
        - zip -r output_file.zip *
        - cp -r output_file.zip /drone/src/netstandard2.0\publish\
       
  - name: Create Rgroup
    image: mcr.microsoft.com/azure-cli
    environment:
      client_ID:
        from_secret: client_ID
      tenant_ID:
        from_secret: tenant_ID
      password:
        from_secret: password
    commands:
      - az login --service-principal -u $client_ID -p $password --tenant $tenant_ID
      - az sql server create -l southeastasia -g WebApp_POC -n rg-demo-db -u $client_ID -p $password

trigger:
  branch:
    - develop
